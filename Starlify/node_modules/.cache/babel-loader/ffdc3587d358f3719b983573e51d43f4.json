{"ast":null,"code":"var _jsxFileName = \"/Users/kirancorreya/Site/Starlify/src/pages/dashboard/graph/Graph.js\";\nimport React, { Component } from 'react';\nimport * as d3 from 'd3';\nimport { connect } from 'react-redux';\nimport _ from 'underscore';\n\nclass Graph extends Component {\n  constructor() {\n    super();\n\n    this.buildForceGraph = systems => {\n      let modelURL = this.props.modelUri;\n      new Promise(async function (resolve, reject) {\n        var items = [];\n        items[\"nodes\"] = [];\n        items[\"links\"] = [];\n\n        for (let i = 0; i < systems.length; i++) {\n          const system = systems[i];\n          items[\"nodes\"].push({\n            \"id\": system.id,\n            \"name\": system.name || \"System\",\n            \"type\": \"system\",\n            \"radius\": 15\n          });\n\n          if (system.services) {\n            for (let j = 0; j < system.services.length; j++) {\n              const service = system.services[j];\n              items[\"nodes\"].push({\n                \"id\": service.id,\n                name: service.name || \"Service\",\n                \"type\": \"service\",\n                \"radius\": 5\n              });\n              items[\"links\"].push({\n                \"source\": system.id,\n                \"target\": service.id,\n                \"type\": \"service\"\n              });\n            }\n          }\n\n          if (system.references) {\n            for (let x = 0; x < system.references.length; x++) {\n              const reference = system.references[x];\n              await fetch(process.env.REACT_APP_API + modelURL + \"/reference/\" + reference.id).then(res => res.json()).then(result => {\n                if (result.service !== undefined) {\n                  items[\"links\"].push({\n                    \"source\": system.id,\n                    \"target\": result.service.id,\n                    \"type\": \"reference\",\n                    \"id\": reference.id\n                  });\n                }\n              });\n            }\n          }\n        }\n\n        resolve(items);\n      }).then(function (items) {\n        var centered = false;\n        var timer;\n        const width = window.innerWidth,\n              height = window.innerHeight;\n        const zoom = d3.zoom().scaleExtent([0.2, 6]).on(\"zoom\", zoomed);\n\n        function zoomed() {\n          g.attr('transform', d3.event.transform);\n        }\n\n        function click() {\n          center();\n        }\n\n        var parent = d3.select(\".forcegraph\");\n        parent.selectAll(\"*\").remove();\n        parent.call(zoom);\n        parent.on(\"click\", click);\n        var svg = parent.append(\"svg\").attr(\"width\", width).attr(\"height\", height) //.call(zoom)\n        .append(\"g\").attr(\"transform\", \"translate(0,0)\");\n        svg.append('defs').append('marker').attr('id', 'service').attr('viewBox', '-5 -5 20 20').attr('refX', 8).attr('refY', 0).attr('orient', 'auto').attr('markerWidth', 25).attr('markerHeight', 25).attr('xoverflow', 'visible').append('svg:path').attr('d', 'M -5 -2 L 0 0 L -5 2 z').attr('fill', '#fff').style('stroke', 'none');\n        const g = svg.append(\"g\"); // Reset camera, set position to center of screen with no zoom.\n        // Necessary if changing model after zoom or pan have been made in previosly shown model.\n\n        parent.call(zoom.transform, d3.zoomIdentity.translate(0, 0).scale(1));\n        var simulation = d3.forceSimulation().force(\"link\", d3.forceLink().id(d => d.id).distance(d => d.type === \"reference\" ? 100 : 10)).force(\"charge\", d3.forceManyBody().strength(-250)).force('gravity', d3.forceRadial(0, 0)).force('x', d3.forceX().strength(0.01)).force('y', d3.forceY().strength(0.01)).force('collide', d3.forceCollide(0)).force(\"center\", d3.forceCenter(width / 2, height / 2));\n        var links = g.selectAll(\".link\").data(items.links).enter().append(\"line\").attr(\"class\", \"link\");\n        var nodes = g.selectAll(\".node\").data(items.nodes).enter().append(\"g\").attr(\"class\", \"node\") //.on(\"click\", d => clicked(d))\n        .call(d3.drag().on(\"start\", dragstarted).on(\"drag\", dragged).on(\"end\", dragended));\n        var circle = nodes.append(\"circle\").attr(\"class\", d => d.type);\n        var label = nodes.append(\"text\").attr(\"dy\", \".35em\").attr(\"class\", d => d.type + \"_label\").text(d => d.name);\n        simulation.nodes(items.nodes).on(\"tick\", tick).on(\"end\", () => {\n          if (!centered) {\n            centered = true;\n            center();\n          }\n        });\n        simulation.force(\"link\").links(items.links);\n\n        function tick() {\n          if (!timer) timer = performance.now();else if (performance.now() - timer > 4000 && !centered) {\n            centered = true;\n            center(0.8);\n          }\n          links.attr(\"x1\", function (d) {\n            return d.source.x;\n          }).attr(\"y1\", function (d) {\n            return d.source.y;\n          }).attr(\"x2\", function (d) {\n            return d.target.x;\n          }).attr(\"y2\", function (d) {\n            return d.target.y;\n          }).attr(\"marker-end\", function (d) {\n            return d.type === \"reference\" ? \"url(#service)\" : \"\";\n          }).attr(\"id\", function (d) {\n            return \"link_\" + d.id;\n          }).attr(\"class\", function (d) {\n            return \"link \" + d.type;\n          });\n          circle.attr(\"id\", function (d) {\n            return \"graph_\" + d.id;\n          }).attr(\"cx\", function (d) {\n            return d.x;\n          }).attr(\"cy\", function (d) {\n            return d.y;\n          }).attr(\"class\", function (d) {\n            return d.type;\n          }).attr(\"r\", d => d.radius);\n          label.attr(\"x\", function (d) {\n            return d.x;\n          }).attr(\"y\", function (d) {\n            return d.y;\n          });\n        }\n\n        function center(scale = 0.8) {\n          var t = getGraphCenter(scale);\n          var identity = d3.zoomIdentity.translate(width / 2, height / 2).scale(t.k).translate(-t.x, -t.y);\n          parent.transition().duration(2500).call(zoom.transform, identity);\n        }\n\n        function getGraphCenter(target) {\n          var nodes = d3.selectAll('circle').data();\n          var range = {\n            x: {\n              min: d3.min(_.pluck(nodes, 'x')),\n              max: d3.max(_.pluck(nodes, 'x'))\n            },\n            y: {\n              min: d3.min(_.pluck(nodes, 'y')),\n              max: d3.max(_.pluck(nodes, 'y'))\n            }\n          };\n          var x = range.x.min + (range.x.max - range.x.min) / 2;\n          var y = range.y.min + (range.y.max - range.y.min) / 2; //target = 0.8;\n\n          var k;\n          (range.x.max - range.x.min) / width > (range.y.max - range.y.min) / height ? k = target / ((range.x.max - range.x.min) / width) : k = target / ((range.y.max - range.y.min) / height);\n          k = k > 6 ? 6 : k;\n          return {\n            x,\n            y,\n            k\n          };\n        }\n\n        function dragstarted(d) {\n          if (!d3.event.active) simulation.alphaTarget(0.3).restart();\n          d.fx = d.x;\n          d.fy = d.y;\n        }\n\n        function dragged(d) {\n          d.fx = d3.event.x;\n          d.fy = d3.event.y;\n        }\n\n        function dragended(d) {\n          if (!d3.event.active) simulation.alphaTarget(0);\n          d.fx = null;\n          d.fy = null;\n        }\n      });\n    };\n\n    this.buildForceGraph = this.buildForceGraph.bind(this);\n    this.state = {\n      load_graph: false,\n      systems: []\n    };\n  }\n\n  componentDidUpdate() {\n    const _this$props = this.props,\n          systems = _this$props.systems,\n          type = _this$props.type;\n\n    switch (type) {\n      case \"SELECTDOMAIN\":\n        this.buildForceGraph([]);\n        break;\n\n      case \"FETCH_MODEL_SUCCESS\":\n        if (systems !== undefined) {\n          this.buildForceGraph(systems);\n        } else {\n          this.buildForceGraph([]);\n        }\n\n        break;\n\n      case \"FETCH_MODEL_FAILURE\":\n        this.buildForceGraph([]);\n        break;\n\n      case \"HIGHLIGHT_SYSTEM\":\n        var activeSys = document.getElementById(\"graph_\" + this.props.activeSystem);\n\n        if (activeSys !== null) {\n          let cols = document.getElementsByClassName('system');\n\n          for (let i = 0; i < cols.length; i++) {\n            cols[i].style.fill = '';\n          }\n\n          activeSys.setAttribute(\"style\", \"fill:#e8455c\");\n        }\n\n        break;\n\n      case \"HIGHLIGHT_SERVICE\":\n        var activeSrvc = document.getElementById(\"graph_\" + this.props.activeService);\n\n        if (activeSrvc !== null) {\n          let cols = document.getElementsByClassName('service');\n\n          for (let i = 0; i < cols.length; i++) {\n            cols[i].style.fill = '';\n          }\n\n          activeSrvc.setAttribute(\"style\", \"fill:#e8455c\");\n        }\n\n        break;\n\n      case \"HIGHLIGHT_REFERENCE\":\n        var activeRfrnc = document.getElementById(\"link_\" + this.props.activeReference);\n\n        if (activeRfrnc !== null) {\n          let cols = document.getElementsByClassName('reference');\n\n          for (let i = 0; i < cols.length; i++) {\n            cols[i].style.stroke = '';\n          }\n\n          activeRfrnc.setAttribute(\"style\", \"stroke:#e8455c\");\n        }\n\n        break;\n\n      default:\n        break;\n    }\n  }\n\n  render() {\n    return React.createElement(\"div\", {\n      className: \"forcegraph\",\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 293\n      },\n      __self: this\n    });\n  }\n\n}\n\nfunction mapStateToProps(state) {\n  return {\n    activeSystem: state.model.activeSystem,\n    activeService: state.model.activeService,\n    activeReference: state.model.activeReference,\n    modelUri: state.model.modelUri,\n    systems: state.model.items,\n    status: state.model.status,\n    type: state.model.type\n  };\n}\n\nexport default connect(mapStateToProps)(Graph);","map":{"version":3,"sources":["/Users/kirancorreya/Site/Starlify/src/pages/dashboard/graph/Graph.js"],"names":["React","Component","d3","connect","_","Graph","constructor","buildForceGraph","systems","modelURL","props","modelUri","Promise","resolve","reject","items","i","length","system","push","id","name","services","j","service","references","x","reference","fetch","process","env","REACT_APP_API","then","res","json","result","undefined","centered","timer","width","window","innerWidth","height","innerHeight","zoom","scaleExtent","on","zoomed","g","attr","event","transform","click","center","parent","select","selectAll","remove","call","svg","append","style","zoomIdentity","translate","scale","simulation","forceSimulation","force","forceLink","d","distance","type","forceManyBody","strength","forceRadial","forceX","forceY","forceCollide","forceCenter","links","data","enter","nodes","drag","dragstarted","dragged","dragended","circle","label","text","tick","performance","now","source","y","target","radius","t","getGraphCenter","identity","k","transition","duration","range","min","pluck","max","active","alphaTarget","restart","fx","fy","bind","state","load_graph","componentDidUpdate","activeSys","document","getElementById","activeSystem","cols","getElementsByClassName","fill","setAttribute","activeSrvc","activeService","activeRfrnc","activeReference","stroke","render","mapStateToProps","model","status"],"mappings":";AAAA,OAAOA,KAAP,IAAgBC,SAAhB,QAAiC,OAAjC;AACA,OAAO,KAAKC,EAAZ,MAAoB,IAApB;AACA,SAASC,OAAT,QAAwB,aAAxB;AACA,OAAOC,CAAP,MAAc,YAAd;;AAEA,MAAMC,KAAN,SAAoBJ,SAApB,CAA8B;AAE5BK,EAAAA,WAAW,GAAE;AACX;;AADW,SASbC,eATa,GASMC,OAAD,IAAa;AAE7B,UAAIC,QAAQ,GAAG,KAAKC,KAAL,CAAWC,QAA1B;AACA,UAAIC,OAAJ,CAAY,gBAAeC,OAAf,EAAwBC,MAAxB,EAAgC;AACxC,YAAIC,KAAK,GAAG,EAAZ;AACAA,QAAAA,KAAK,CAAC,OAAD,CAAL,GAAiB,EAAjB;AACAA,QAAAA,KAAK,CAAC,OAAD,CAAL,GAAiB,EAAjB;;AAEA,aAAK,IAAIC,CAAC,GAAG,CAAb,EAAgBA,CAAC,GAAGR,OAAO,CAACS,MAA5B,EAAoCD,CAAC,EAArC,EAAyC;AACvC,gBAAME,MAAM,GAAGV,OAAO,CAACQ,CAAD,CAAtB;AACAD,UAAAA,KAAK,CAAC,OAAD,CAAL,CAAeI,IAAf,CAAoB;AAAE,kBAAMD,MAAM,CAACE,EAAf;AAAmB,oBAAQF,MAAM,CAACG,IAAP,IAAgB,QAA3C;AAAqD,oBAAQ,QAA7D;AAAuE,sBAAU;AAAjF,WAApB;;AAEA,cAAIH,MAAM,CAACI,QAAX,EAAoB;AAClB,iBAAK,IAAIC,CAAC,GAAG,CAAb,EAAgBA,CAAC,GAAGL,MAAM,CAACI,QAAP,CAAgBL,MAApC,EAA4CM,CAAC,EAA7C,EAAiD;AAC/C,oBAAMC,OAAO,GAAGN,MAAM,CAACI,QAAP,CAAgBC,CAAhB,CAAhB;AACAR,cAAAA,KAAK,CAAC,OAAD,CAAL,CAAeI,IAAf,CAAoB;AAAE,sBAAMK,OAAO,CAACJ,EAAhB;AAAoBC,gBAAAA,IAAI,EAAEG,OAAO,CAACH,IAAR,IAAgB,SAA1C;AAAqD,wBAAQ,SAA7D;AAAwE,0BAAU;AAAlF,eAApB;AACAN,cAAAA,KAAK,CAAC,OAAD,CAAL,CAAeI,IAAf,CAAoB;AAAC,0BAAUD,MAAM,CAACE,EAAlB;AAAsB,0BAAUI,OAAO,CAACJ,EAAxC;AAA4C,wBAAQ;AAApD,eAApB;AAED;AACF;;AAED,cAAIF,MAAM,CAACO,UAAX,EAAsB;AACpB,iBAAK,IAAIC,CAAC,GAAG,CAAb,EAAgBA,CAAC,GAAGR,MAAM,CAACO,UAAP,CAAkBR,MAAtC,EAA8CS,CAAC,EAA/C,EAAmD;AACjD,oBAAMC,SAAS,GAAGT,MAAM,CAACO,UAAP,CAAkBC,CAAlB,CAAlB;AACA,oBAAME,KAAK,CAACC,OAAO,CAACC,GAAR,CAAYC,aAAZ,GAA4BtB,QAA5B,GAAuC,aAAvC,GAAuDkB,SAAS,CAACP,EAAlE,CAAL,CACLY,IADK,CACAC,GAAG,IAAIA,GAAG,CAACC,IAAJ,EADP,EAELF,IAFK,CAECG,MAAD,IAAY;AAChB,oBAAIA,MAAM,CAACX,OAAP,KAAmBY,SAAvB,EAAkC;AAChCrB,kBAAAA,KAAK,CAAC,OAAD,CAAL,CAAeI,IAAf,CAAoB;AAAC,8BAAUD,MAAM,CAACE,EAAlB;AAAsB,8BAAUe,MAAM,CAACX,OAAP,CAAeJ,EAA/C;AAAmD,4BAAQ,WAA3D;AAAwE,0BAAMO,SAAS,CAACP;AAAxF,mBAApB;AACD;AACF,eANK,CAAN;AAOD;AACF;AACF;;AAEDP,QAAAA,OAAO,CAACE,KAAD,CAAP;AAED,OAlCH,EAkCKiB,IAlCL,CAkCU,UAASjB,KAAT,EAAgB;AAEtB,YAAIsB,QAAQ,GAAG,KAAf;AACA,YAAIC,KAAJ;AACA,cAAMC,KAAK,GAAGC,MAAM,CAACC,UAArB;AAAA,cACMC,MAAM,GAAGF,MAAM,CAACG,WADtB;AAGA,cAAMC,IAAI,GAAG1C,EAAE,CAAC0C,IAAH,GACVC,WADU,CACE,CAAC,GAAD,EAAM,CAAN,CADF,EAEVC,EAFU,CAEP,MAFO,EAECC,MAFD,CAAb;;AAIA,iBAASA,MAAT,GAAkB;AAChBC,UAAAA,CAAC,CAACC,IAAF,CAAO,WAAP,EAAoB/C,EAAE,CAACgD,KAAH,CAASC,SAA7B;AACD;;AAED,iBAASC,KAAT,GAAiB;AACfC,UAAAA,MAAM;AACP;;AAED,YAAIC,MAAM,GAAGpD,EAAE,CAACqD,MAAH,CAAU,aAAV,CAAb;AACAD,QAAAA,MAAM,CAACE,SAAP,CAAiB,GAAjB,EAAsBC,MAAtB;AACAH,QAAAA,MAAM,CAACI,IAAP,CAAYd,IAAZ;AACAU,QAAAA,MAAM,CAACR,EAAP,CAAU,OAAV,EAAmBM,KAAnB;AACA,YAAIO,GAAG,GAAGL,MAAM,CAACM,MAAP,CAAc,KAAd,EACLX,IADK,CACA,OADA,EACSV,KADT,EAELU,IAFK,CAEA,QAFA,EAEUP,MAFV,EAGN;AAHM,SAILkB,MAJK,CAIE,GAJF,EAKLX,IALK,CAKA,WALA,EAKa,gBALb,CAAV;AAOEU,QAAAA,GAAG,CAACC,MAAJ,CAAW,MAAX,EAAmBA,MAAnB,CAA0B,QAA1B,EACGX,IADH,CACQ,IADR,EACc,SADd,EAEGA,IAFH,CAEQ,SAFR,EAEmB,aAFnB,EAGGA,IAHH,CAGQ,MAHR,EAGgB,CAHhB,EAIGA,IAJH,CAIQ,MAJR,EAIgB,CAJhB,EAKGA,IALH,CAKQ,QALR,EAKkB,MALlB,EAMGA,IANH,CAMQ,aANR,EAMuB,EANvB,EAOGA,IAPH,CAOQ,cAPR,EAOwB,EAPxB,EAQGA,IARH,CAQQ,WARR,EAQqB,SARrB,EASGW,MATH,CASU,UATV,EAUGX,IAVH,CAUQ,GAVR,EAUa,wBAVb,EAWGA,IAXH,CAWQ,MAXR,EAWgB,MAXhB,EAYGY,KAZH,CAYS,QAZT,EAYkB,MAZlB;AAcF,cAAMb,CAAC,GAAGW,GAAG,CAACC,MAAJ,CAAW,GAAX,CAAV,CA5CsB,CA8CtB;AACA;;AACAN,QAAAA,MAAM,CAACI,IAAP,CAAYd,IAAI,CAACO,SAAjB,EAA4BjD,EAAE,CAAC4D,YAAH,CAAgBC,SAAhB,CAA0B,CAA1B,EAA6B,CAA7B,EAAgCC,KAAhC,CAAsC,CAAtC,CAA5B;AAEA,YAAIC,UAAU,GAAG/D,EAAE,CAACgE,eAAH,GACdC,KADc,CACR,MADQ,EACAjE,EAAE,CAACkE,SAAH,GAAehD,EAAf,CAAkBiD,CAAC,IAAIA,CAAC,CAACjD,EAAzB,EACZkD,QADY,CACHD,CAAC,IAAIA,CAAC,CAACE,IAAF,KAAW,WAAX,GAAyB,GAAzB,GAA+B,EADjC,CADA,EAGdJ,KAHc,CAGR,QAHQ,EAGEjE,EAAE,CAACsE,aAAH,GAAmBC,QAAnB,CAA4B,CAAC,GAA7B,CAHF,EAIdN,KAJc,CAIR,SAJQ,EAIGjE,EAAE,CAACwE,WAAH,CAAe,CAAf,EAAkB,CAAlB,CAJH,EAKdP,KALc,CAKR,GALQ,EAKHjE,EAAE,CAACyE,MAAH,GAAYF,QAAZ,CAAqB,IAArB,CALG,EAMdN,KANc,CAMR,GANQ,EAMHjE,EAAE,CAAC0E,MAAH,GAAYH,QAAZ,CAAqB,IAArB,CANG,EAOdN,KAPc,CAOR,SAPQ,EAOGjE,EAAE,CAAC2E,YAAH,CAAgB,CAAhB,CAPH,EAQdV,KARc,CAQR,QARQ,EAQEjE,EAAE,CAAC4E,WAAH,CAAevC,KAAK,GAAG,CAAvB,EAA0BG,MAAM,GAAG,CAAnC,CARF,CAAjB;AAUA,YAAIqC,KAAK,GAAG/B,CAAC,CAACQ,SAAF,CAAY,OAAZ,EACTwB,IADS,CACJjE,KAAK,CAACgE,KADF,EAETE,KAFS,GAEDrB,MAFC,CAEM,MAFN,EAGTX,IAHS,CAGJ,OAHI,EAGK,MAHL,CAAZ;AAKA,YAAIiC,KAAK,GAAGlC,CAAC,CAACQ,SAAF,CAAY,OAAZ,EACTwB,IADS,CACJjE,KAAK,CAACmE,KADF,EAETD,KAFS,GAEDrB,MAFC,CAEM,GAFN,EAGTX,IAHS,CAGJ,OAHI,EAGK,MAHL,EAIV;AAJU,SAKTS,IALS,CAKJxD,EAAE,CAACiF,IAAH,GACHrC,EADG,CACA,OADA,EACSsC,WADT,EAEHtC,EAFG,CAEA,MAFA,EAEQuC,OAFR,EAGHvC,EAHG,CAGA,KAHA,EAGOwC,SAHP,CALI,CAAZ;AAWA,YAAIC,MAAM,GAAGL,KAAK,CAACtB,MAAN,CAAa,QAAb,EACVX,IADU,CACL,OADK,EACIoB,CAAC,IAAIA,CAAC,CAACE,IADX,CAAb;AAGA,YAAIiB,KAAK,GAAGN,KAAK,CAACtB,MAAN,CAAa,MAAb,EACTX,IADS,CACJ,IADI,EACE,OADF,EAETA,IAFS,CAEJ,OAFI,EAEKoB,CAAC,IAAIA,CAAC,CAACE,IAAF,GAAS,QAFnB,EAGTkB,IAHS,CAGJpB,CAAC,IAAIA,CAAC,CAAChD,IAHH,CAAZ;AAKA4C,QAAAA,UAAU,CACPiB,KADH,CACSnE,KAAK,CAACmE,KADf,EAEGpC,EAFH,CAEM,MAFN,EAEc4C,IAFd,EAGG5C,EAHH,CAGM,KAHN,EAGa,MAAM;AACf,cAAI,CAACT,QAAL,EAAe;AACbA,YAAAA,QAAQ,GAAG,IAAX;AACAgB,YAAAA,MAAM;AACP;AACF,SARH;AAUAY,QAAAA,UAAU,CACPE,KADH,CACS,MADT,EAEGY,KAFH,CAEShE,KAAK,CAACgE,KAFf;;AAIA,iBAASW,IAAT,GAAgB;AACd,cAAI,CAACpD,KAAL,EACEA,KAAK,GAAGqD,WAAW,CAACC,GAAZ,EAAR,CADF,KAEK,IAAKD,WAAW,CAACC,GAAZ,KAAoBtD,KAArB,GAA8B,IAA9B,IAAsC,CAACD,QAA3C,EAAoD;AACvDA,YAAAA,QAAQ,GAAG,IAAX;AACAgB,YAAAA,MAAM,CAAC,GAAD,CAAN;AACD;AAED0B,UAAAA,KAAK,CACF9B,IADH,CACQ,IADR,EACc,UAAUoB,CAAV,EAAa;AAAE,mBAAOA,CAAC,CAACwB,MAAF,CAASnE,CAAhB;AAAoB,WADjD,EAEGuB,IAFH,CAEQ,IAFR,EAEc,UAAUoB,CAAV,EAAa;AAAE,mBAAOA,CAAC,CAACwB,MAAF,CAASC,CAAhB;AAAoB,WAFjD,EAGG7C,IAHH,CAGQ,IAHR,EAGc,UAAUoB,CAAV,EAAa;AAAE,mBAAOA,CAAC,CAAC0B,MAAF,CAASrE,CAAhB;AAAoB,WAHjD,EAIGuB,IAJH,CAIQ,IAJR,EAIc,UAAUoB,CAAV,EAAa;AAAE,mBAAOA,CAAC,CAAC0B,MAAF,CAASD,CAAhB;AAAoB,WAJjD,EAKG7C,IALH,CAKQ,YALR,EAKsB,UAASoB,CAAT,EAAY;AAC9B,mBAAOA,CAAC,CAACE,IAAF,KAAW,WAAX,GAAyB,eAAzB,GAA2C,EAAlD;AACD,WAPH,EAQGtB,IARH,CAQQ,IARR,EAQc,UAASoB,CAAT,EAAY;AAAE,mBAAO,UAAQA,CAAC,CAACjD,EAAjB;AAAsB,WARlD,EASG6B,IATH,CASQ,OATR,EASiB,UAASoB,CAAT,EAAY;AAAE,mBAAO,UAAQA,CAAC,CAACE,IAAjB;AAAwB,WATvD;AAWAgB,UAAAA,MAAM,CACHtC,IADH,CACQ,IADR,EACc,UAASoB,CAAT,EAAY;AAAE,mBAAO,WAASA,CAAC,CAACjD,EAAlB;AAAuB,WADnD,EAEG6B,IAFH,CAEQ,IAFR,EAEc,UAASoB,CAAT,EAAY;AAAE,mBAAOA,CAAC,CAAC3C,CAAT;AAAa,WAFzC,EAGGuB,IAHH,CAGQ,IAHR,EAGc,UAASoB,CAAT,EAAY;AAAE,mBAAOA,CAAC,CAACyB,CAAT;AAAa,WAHzC,EAIG7C,IAJH,CAIQ,OAJR,EAIiB,UAASoB,CAAT,EAAY;AAAE,mBAAOA,CAAC,CAACE,IAAT;AAAgB,WAJ/C,EAKGtB,IALH,CAKQ,GALR,EAKaoB,CAAC,IAAIA,CAAC,CAAC2B,MALpB;AAOAR,UAAAA,KAAK,CACFvC,IADH,CACQ,GADR,EACa,UAASoB,CAAT,EAAY;AAAE,mBAAOA,CAAC,CAAC3C,CAAT;AAAa,WADxC,EAEGuB,IAFH,CAEQ,GAFR,EAEa,UAASoB,CAAT,EAAY;AAAE,mBAAOA,CAAC,CAACyB,CAAT;AAAa,WAFxC;AAGD;;AAED,iBAASzC,MAAT,CAAgBW,KAAK,GAAG,GAAxB,EAA6B;AAC3B,cAAIiC,CAAC,GAAGC,cAAc,CAAClC,KAAD,CAAtB;AACA,cAAImC,QAAQ,GAAGjG,EAAE,CAAC4D,YAAH,CAAgBC,SAAhB,CAA0BxB,KAAK,GAAG,CAAlC,EAAqCG,MAAM,GAAG,CAA9C,EAAiDsB,KAAjD,CAAuDiC,CAAC,CAACG,CAAzD,EAA4DrC,SAA5D,CAAsE,CAACkC,CAAC,CAACvE,CAAzE,EAA4E,CAACuE,CAAC,CAACH,CAA/E,CAAf;AACAxC,UAAAA,MAAM,CAAC+C,UAAP,GAAoBC,QAApB,CAA6B,IAA7B,EAAmC5C,IAAnC,CACEd,IAAI,CAACO,SADP,EAEEgD,QAFF;AAID;;AAED,iBAASD,cAAT,CAAwBH,MAAxB,EAAgC;AAC9B,cAAIb,KAAK,GAAGhF,EAAE,CAACsD,SAAH,CAAa,QAAb,EAAuBwB,IAAvB,EAAZ;AACA,cAAIuB,KAAK,GAAG;AACV7E,YAAAA,CAAC,EAAE;AAAC8E,cAAAA,GAAG,EAAEtG,EAAE,CAACsG,GAAH,CAAOpG,CAAC,CAACqG,KAAF,CAAQvB,KAAR,EAAe,GAAf,CAAP,CAAN;AACCwB,cAAAA,GAAG,EAAExG,EAAE,CAACwG,GAAH,CAAOtG,CAAC,CAACqG,KAAF,CAAQvB,KAAR,EAAe,GAAf,CAAP;AADN,aADO;AAGVY,YAAAA,CAAC,EAAE;AAACU,cAAAA,GAAG,EAAEtG,EAAE,CAACsG,GAAH,CAAOpG,CAAC,CAACqG,KAAF,CAAQvB,KAAR,EAAe,GAAf,CAAP,CAAN;AACCwB,cAAAA,GAAG,EAAExG,EAAE,CAACwG,GAAH,CAAOtG,CAAC,CAACqG,KAAF,CAAQvB,KAAR,EAAe,GAAf,CAAP;AADN;AAHO,WAAZ;AAMA,cAAIxD,CAAC,GAAG6E,KAAK,CAAC7E,CAAN,CAAQ8E,GAAR,GAAe,CAACD,KAAK,CAAC7E,CAAN,CAAQgF,GAAR,GAAcH,KAAK,CAAC7E,CAAN,CAAQ8E,GAAvB,IAA8B,CAArD;AACA,cAAIV,CAAC,GAAGS,KAAK,CAACT,CAAN,CAAQU,GAAR,GAAe,CAACD,KAAK,CAACT,CAAN,CAAQY,GAAR,GAAcH,KAAK,CAACT,CAAN,CAAQU,GAAvB,IAA8B,CAArD,CAT8B,CAU9B;;AACA,cAAIJ,CAAJ;AACC,WAACG,KAAK,CAAC7E,CAAN,CAAQgF,GAAR,GAAcH,KAAK,CAAC7E,CAAN,CAAQ8E,GAAvB,IAA4BjE,KAA7B,GAAuC,CAACgE,KAAK,CAACT,CAAN,CAAQY,GAAR,GAAcH,KAAK,CAACT,CAAN,CAAQU,GAAvB,IAA4B9D,MAAnE,GACE0D,CAAC,GAAIL,MAAM,IAAE,CAACQ,KAAK,CAAC7E,CAAN,CAAQgF,GAAR,GAAcH,KAAK,CAAC7E,CAAN,CAAQ8E,GAAvB,IAA4BjE,KAA9B,CADb,GAEE6D,CAAC,GAAIL,MAAM,IAAE,CAACQ,KAAK,CAACT,CAAN,CAAQY,GAAR,GAAcH,KAAK,CAACT,CAAN,CAAQU,GAAvB,IAA4B9D,MAA9B,CAFb;AAGA0D,UAAAA,CAAC,GAAGA,CAAC,GAAG,CAAJ,GAAQ,CAAR,GAAYA,CAAhB;AACA,iBAAO;AAAC1E,YAAAA,CAAD;AAAIoE,YAAAA,CAAJ;AAAOM,YAAAA;AAAP,WAAP;AACD;;AAED,iBAAShB,WAAT,CAAqBf,CAArB,EAAwB;AACtB,cAAI,CAACnE,EAAE,CAACgD,KAAH,CAASyD,MAAd,EAAsB1C,UAAU,CAAC2C,WAAX,CAAuB,GAAvB,EAA4BC,OAA5B;AACtBxC,UAAAA,CAAC,CAACyC,EAAF,GAAOzC,CAAC,CAAC3C,CAAT;AACA2C,UAAAA,CAAC,CAAC0C,EAAF,GAAO1C,CAAC,CAACyB,CAAT;AACD;;AAED,iBAAST,OAAT,CAAiBhB,CAAjB,EAAoB;AAClBA,UAAAA,CAAC,CAACyC,EAAF,GAAO5G,EAAE,CAACgD,KAAH,CAASxB,CAAhB;AACA2C,UAAAA,CAAC,CAAC0C,EAAF,GAAO7G,EAAE,CAACgD,KAAH,CAAS4C,CAAhB;AACD;;AAED,iBAASR,SAAT,CAAmBjB,CAAnB,EAAsB;AACpB,cAAI,CAACnE,EAAE,CAACgD,KAAH,CAASyD,MAAd,EAAsB1C,UAAU,CAAC2C,WAAX,CAAuB,CAAvB;AACtBvC,UAAAA,CAAC,CAACyC,EAAF,GAAO,IAAP;AACAzC,UAAAA,CAAC,CAAC0C,EAAF,GAAO,IAAP;AACD;AAEF,OAhNH;AAkND,KA9NY;;AAEX,SAAKxG,eAAL,GAAuB,KAAKA,eAAL,CAAqByG,IAArB,CAA0B,IAA1B,CAAvB;AACA,SAAKC,KAAL,GAAa;AACXC,MAAAA,UAAU,EAAE,KADD;AAEX1G,MAAAA,OAAO,EAAE;AAFE,KAAb;AAID;;AA0ND2G,EAAAA,kBAAkB,GAAE;AAAA,wBAEO,KAAKzG,KAFZ;AAAA,UAEVF,OAFU,eAEVA,OAFU;AAAA,UAED+D,IAFC,eAEDA,IAFC;;AAIlB,YAAQA,IAAR;AAEE,WAAK,cAAL;AACI,aAAKhE,eAAL,CAAqB,EAArB;AACJ;;AACA,WAAK,qBAAL;AACE,YAAGC,OAAO,KAAK4B,SAAf,EAAyB;AACrB,eAAK7B,eAAL,CAAqBC,OAArB;AACH,SAFD,MAEK;AACH,eAAKD,eAAL,CAAqB,EAArB;AACD;;AACH;;AACA,WAAK,qBAAL;AACI,aAAKA,eAAL,CAAqB,EAArB;AACJ;;AAEA,WAAK,kBAAL;AACE,YAAI6G,SAAS,GAAGC,QAAQ,CAACC,cAAT,CAAwB,WAAS,KAAK5G,KAAL,CAAW6G,YAA5C,CAAhB;;AACA,YAAGH,SAAS,KAAK,IAAjB,EAAsB;AACpB,cAAII,IAAI,GAAGH,QAAQ,CAACI,sBAAT,CAAgC,QAAhC,CAAX;;AACA,eAAI,IAAIzG,CAAC,GAAG,CAAZ,EAAeA,CAAC,GAAGwG,IAAI,CAACvG,MAAxB,EAAgCD,CAAC,EAAjC,EAAqC;AACnCwG,YAAAA,IAAI,CAACxG,CAAD,CAAJ,CAAQ6C,KAAR,CAAc6D,IAAd,GAAqB,EAArB;AACD;;AACDN,UAAAA,SAAS,CAACO,YAAV,CAAuB,OAAvB,EAAgC,cAAhC;AACD;;AACH;;AAEA,WAAK,mBAAL;AACE,YAAIC,UAAU,GAAGP,QAAQ,CAACC,cAAT,CAAwB,WAAS,KAAK5G,KAAL,CAAWmH,aAA5C,CAAjB;;AACA,YAAGD,UAAU,KAAK,IAAlB,EAAuB;AACrB,cAAIJ,IAAI,GAAGH,QAAQ,CAACI,sBAAT,CAAgC,SAAhC,CAAX;;AACA,eAAI,IAAIzG,CAAC,GAAG,CAAZ,EAAeA,CAAC,GAAGwG,IAAI,CAACvG,MAAxB,EAAgCD,CAAC,EAAjC,EAAqC;AACnCwG,YAAAA,IAAI,CAACxG,CAAD,CAAJ,CAAQ6C,KAAR,CAAc6D,IAAd,GAAqB,EAArB;AACD;;AACDE,UAAAA,UAAU,CAACD,YAAX,CAAwB,OAAxB,EAAiC,cAAjC;AACD;;AACH;;AAEA,WAAK,qBAAL;AACE,YAAIG,WAAW,GAAGT,QAAQ,CAACC,cAAT,CAAwB,UAAQ,KAAK5G,KAAL,CAAWqH,eAA3C,CAAlB;;AACA,YAAGD,WAAW,KAAK,IAAnB,EAAwB;AACtB,cAAIN,IAAI,GAAGH,QAAQ,CAACI,sBAAT,CAAgC,WAAhC,CAAX;;AACA,eAAI,IAAIzG,CAAC,GAAG,CAAZ,EAAeA,CAAC,GAAGwG,IAAI,CAACvG,MAAxB,EAAgCD,CAAC,EAAjC,EAAqC;AACnCwG,YAAAA,IAAI,CAACxG,CAAD,CAAJ,CAAQ6C,KAAR,CAAcmE,MAAd,GAAuB,EAAvB;AACD;;AACDF,UAAAA,WAAW,CAACH,YAAZ,CAAyB,OAAzB,EAAkC,gBAAlC;AACD;;AACH;;AAEA;AACE;AAlDJ;AAoDD;;AAEDM,EAAAA,MAAM,GAAG;AACP,WACI;AAAK,MAAA,SAAS,EAAC,YAAf;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,MADJ;AAGD;;AAjS2B;;AAoS9B,SAASC,eAAT,CAAyBjB,KAAzB,EAA+B;AAC7B,SAAM;AACJM,IAAAA,YAAY,EAAEN,KAAK,CAACkB,KAAN,CAAYZ,YADtB;AAEJM,IAAAA,aAAa,EAAEZ,KAAK,CAACkB,KAAN,CAAYN,aAFvB;AAGJE,IAAAA,eAAe,EAAEd,KAAK,CAACkB,KAAN,CAAYJ,eAHzB;AAIJpH,IAAAA,QAAQ,EAAEsG,KAAK,CAACkB,KAAN,CAAYxH,QAJlB;AAKJH,IAAAA,OAAO,EAAEyG,KAAK,CAACkB,KAAN,CAAYpH,KALjB;AAMJqH,IAAAA,MAAM,EAAEnB,KAAK,CAACkB,KAAN,CAAYC,MANhB;AAOJ7D,IAAAA,IAAI,EAAE0C,KAAK,CAACkB,KAAN,CAAY5D;AAPd,GAAN;AASD;;AAED,eAAepE,OAAO,CAAC+H,eAAD,CAAP,CAAyB7H,KAAzB,CAAf","sourcesContent":["import React, { Component } from 'react';\nimport * as d3 from 'd3';\nimport { connect } from 'react-redux';\nimport _ from 'underscore';\n\nclass Graph extends Component {\n\n  constructor(){\n    super();\n    this.buildForceGraph = this.buildForceGraph.bind(this);\n    this.state = {\n      load_graph: false,\n      systems: []\n    }\n  }\n\n  buildForceGraph = (systems) => {\n\n    let modelURL = this.props.modelUri;\n    new Promise(async function(resolve, reject) {\n        var items = [];\n        items[\"nodes\"] = [];\n        items[\"links\"] = [];\n\n        for (let i = 0; i < systems.length; i++) {\n          const system = systems[i];\n          items[\"nodes\"].push({ \"id\": system.id, \"name\": system.name  || \"System\", \"type\": \"system\", \"radius\": 15 });\n\n          if (system.services){\n            for (let j = 0; j < system.services.length; j++) {\n              const service = system.services[j];\n              items[\"nodes\"].push({ \"id\": service.id, name: service.name || \"Service\", \"type\": \"service\", \"radius\": 5 });\n              items[\"links\"].push({\"source\": system.id, \"target\": service.id, \"type\": \"service\"});\n\n            }\n          }\n\n          if (system.references){\n            for (let x = 0; x < system.references.length; x++) {\n              const reference = system.references[x];\n              await fetch(process.env.REACT_APP_API + modelURL + \"/reference/\" + reference.id)\n              .then(res => res.json())\n              .then((result) => {\n                if (result.service !== undefined) {\n                  items[\"links\"].push({\"source\": system.id, \"target\": result.service.id, \"type\": \"reference\", \"id\": reference.id});\n                }\n              })\n            }\n          }\n        }\n\n        resolve(items);\n\n      }).then(function(items) {\n\n        var centered = false;\n        var timer;\n        const width = window.innerWidth,\n              height = window.innerHeight;\n\n        const zoom = d3.zoom()\n          .scaleExtent([0.2, 6])\n          .on(\"zoom\", zoomed);\n\n        function zoomed() {\n          g.attr('transform', d3.event.transform)\n        }\n\n        function click() {\n          center()\n        }\n\n        var parent = d3.select(\".forcegraph\");\n        parent.selectAll(\"*\").remove();\n        parent.call(zoom)\n        parent.on(\"click\", click)\n        var svg = parent.append(\"svg\")\n            .attr(\"width\", width)\n            .attr(\"height\", height)\n            //.call(zoom)\n            .append(\"g\")\n            .attr(\"transform\", \"translate(0,0)\");\n\n          svg.append('defs').append('marker')\n            .attr('id', 'service')\n            .attr('viewBox', '-5 -5 20 20')\n            .attr('refX', 8)\n            .attr('refY', 0)\n            .attr('orient', 'auto')\n            .attr('markerWidth', 25)\n            .attr('markerHeight', 25)\n            .attr('xoverflow', 'visible')\n            .append('svg:path')\n            .attr('d', 'M -5 -2 L 0 0 L -5 2 z')\n            .attr('fill', '#fff')\n            .style('stroke','none');\n\n        const g = svg.append(\"g\");\n\n        // Reset camera, set position to center of screen with no zoom.\n        // Necessary if changing model after zoom or pan have been made in previosly shown model.\n        parent.call(zoom.transform, d3.zoomIdentity.translate(0, 0).scale(1))\n\n        var simulation = d3.forceSimulation()\n          .force(\"link\", d3.forceLink().id(d => d.id)\n            .distance(d => d.type === \"reference\" ? 100 : 10))\n          .force(\"charge\", d3.forceManyBody().strength(-250 ))\n          .force('gravity', d3.forceRadial(0, 0))\n          .force('x', d3.forceX().strength(0.01))\n          .force('y', d3.forceY().strength(0.01))\n          .force('collide', d3.forceCollide(0))\n          .force(\"center\", d3.forceCenter(width / 2, height / 2));\n\n        var links = g.selectAll(\".link\")\n          .data(items.links)\n          .enter().append(\"line\")\n          .attr(\"class\", \"link\");\n\n        var nodes = g.selectAll(\".node\")\n          .data(items.nodes)\n          .enter().append(\"g\")\n          .attr(\"class\", \"node\")\n          //.on(\"click\", d => clicked(d))\n          .call(d3.drag()\n            .on(\"start\", dragstarted)\n            .on(\"drag\", dragged)\n            .on(\"end\", dragended)\n          );\n\n        var circle = nodes.append(\"circle\")\n          .attr(\"class\", d => d.type);\n\n        var label = nodes.append(\"text\")\n          .attr(\"dy\", \".35em\")\n          .attr(\"class\", d => d.type + \"_label\")\n          .text(d => d.name);\n\n        simulation\n          .nodes(items.nodes)\n          .on(\"tick\", tick)\n          .on(\"end\", () => {\n            if (!centered) {\n              centered = true;\n              center()\n            }\n          });\n\n        simulation\n          .force(\"link\")\n          .links(items.links);\n\n        function tick() {\n          if (!timer)\n            timer = performance.now()\n          else if ((performance.now() - timer) > 4000 && !centered){\n            centered = true;\n            center(0.8)\n          }\n\n          links\n            .attr(\"x1\", function (d) { return d.source.x; })\n            .attr(\"y1\", function (d) { return d.source.y; })\n            .attr(\"x2\", function (d) { return d.target.x; })\n            .attr(\"y2\", function (d) { return d.target.y; })\n            .attr(\"marker-end\", function(d) {\n              return d.type === \"reference\" ? \"url(#service)\" : \"\";\n            })\n            .attr(\"id\", function(d) { return \"link_\"+d.id; })\n            .attr(\"class\", function(d) { return \"link \"+d.type; });\n\n          circle\n            .attr(\"id\", function(d) { return \"graph_\"+d.id; })\n            .attr(\"cx\", function(d) { return d.x; })\n            .attr(\"cy\", function(d) { return d.y; })\n            .attr(\"class\", function(d) { return d.type; })\n            .attr(\"r\", d => d.radius);\n\n          label\n            .attr(\"x\", function(d) { return d.x; })\n            .attr(\"y\", function(d) { return d.y; });\n        }\n\n        function center(scale = 0.8) {\n          var t = getGraphCenter(scale)\n          var identity = d3.zoomIdentity.translate(width / 2, height / 2).scale(t.k).translate(-t.x, -t.y)\n          parent.transition().duration(2500).call(\n            zoom.transform,\n            identity\n          );\n        }\n\n        function getGraphCenter(target) {\n          var nodes = d3.selectAll('circle').data()\n          var range = {\n            x: {min: d3.min(_.pluck(nodes, 'x')),\n                max: d3.max(_.pluck(nodes, 'x'))},\n            y: {min: d3.min(_.pluck(nodes, 'y')),\n                max: d3.max(_.pluck(nodes, 'y'))}\n          }\n          var x = range.x.min + ((range.x.max - range.x.min) / 2)\n          var y = range.y.min + ((range.y.max - range.y.min) / 2)\n          //target = 0.8;\n          var k;\n          ((range.x.max - range.x.min)/width) > ((range.y.max - range.y.min)/height) ?\n            k = (target/((range.x.max - range.x.min)/width)) :\n            k = (target/((range.y.max - range.y.min)/height));\n          k = k > 6 ? 6 : k;\n          return {x, y, k}\n        }\n\n        function dragstarted(d) {\n          if (!d3.event.active) simulation.alphaTarget(0.3).restart();\n          d.fx = d.x;\n          d.fy = d.y;\n        }\n\n        function dragged(d) {\n          d.fx = d3.event.x;\n          d.fy = d3.event.y;\n        }\n\n        function dragended(d) {\n          if (!d3.event.active) simulation.alphaTarget(0);\n          d.fx = null;\n          d.fy = null;\n        }\n\n      });\n\n  }\n\n\n  componentDidUpdate(){\n\n    const { systems, type} = this.props;\n\n    switch (type) {\n\n      case \"SELECTDOMAIN\":\n          this.buildForceGraph([]);\n      break;\n      case \"FETCH_MODEL_SUCCESS\":\n        if(systems !== undefined){\n            this.buildForceGraph(systems)\n        }else{\n          this.buildForceGraph([]);\n        }\n      break;\n      case \"FETCH_MODEL_FAILURE\":\n          this.buildForceGraph([]);\n      break;\n\n      case \"HIGHLIGHT_SYSTEM\":\n        var activeSys = document.getElementById(\"graph_\"+this.props.activeSystem)\n        if(activeSys !== null){\n          let cols = document.getElementsByClassName('system');\n          for(let i = 0; i < cols.length; i++) {\n            cols[i].style.fill = '';\n          }\n          activeSys.setAttribute(\"style\", \"fill:#e8455c\");\n        }\n      break;\n\n      case \"HIGHLIGHT_SERVICE\":\n        var activeSrvc = document.getElementById(\"graph_\"+this.props.activeService)\n        if(activeSrvc !== null){\n          let cols = document.getElementsByClassName('service');\n          for(let i = 0; i < cols.length; i++) {\n            cols[i].style.fill = '';\n          }\n          activeSrvc.setAttribute(\"style\", \"fill:#e8455c\");\n        }\n      break;\n\n      case \"HIGHLIGHT_REFERENCE\":\n        var activeRfrnc = document.getElementById(\"link_\"+this.props.activeReference)\n        if(activeRfrnc !== null){\n          let cols = document.getElementsByClassName('reference');\n          for(let i = 0; i < cols.length; i++) {\n            cols[i].style.stroke = '';\n          }\n          activeRfrnc.setAttribute(\"style\", \"stroke:#e8455c\");\n        }\n      break;\n\n      default:\n        break;\n    }\n  }\n\n  render() {\n    return (\n        <div className=\"forcegraph\"></div>\n    )\n  }\n}\n\nfunction mapStateToProps(state){\n  return{\n    activeSystem: state.model.activeSystem,\n    activeService: state.model.activeService,\n    activeReference: state.model.activeReference,\n    modelUri: state.model.modelUri,\n    systems: state.model.items,\n    status: state.model.status,\n    type: state.model.type,\n  }\n}\n\nexport default connect(mapStateToProps)(Graph);\n"]},"metadata":{},"sourceType":"module"}