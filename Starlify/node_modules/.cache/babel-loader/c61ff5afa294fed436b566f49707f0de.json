{"ast":null,"code":"/**\n * @param  {Array<THREE.Material>|THREE.Material} material\n * @return {Array<THREE.Material>}\n */\nfunction ensureMaterialArray(material) {\n  if (!material) {\n    return [];\n  } else if (Array.isArray(material)) {\n    return material;\n  } else if (material.materials) {\n    return material.materials;\n  } else {\n    return [material];\n  }\n}\n/**\n * @param  {THREE.Object3D} mesh\n * @param  {Array<string>} materialNames\n * @param  {THREE.Texture} envMap\n * @param  {number} reflectivity  [description]\n */\n\n\nfunction applyEnvMap(mesh, materialNames, envMap, reflectivity) {\n  if (!mesh) return;\n  materialNames = materialNames || [];\n  mesh.traverse(node => {\n    if (!node.isMesh) return;\n    const meshMaterials = ensureMaterialArray(node.material);\n    meshMaterials.forEach(material => {\n      if (material && !('envMap' in material)) return;\n      if (materialNames.length && materialNames.indexOf(material.name) === -1) return;\n      material.envMap = envMap;\n      material.reflectivity = reflectivity;\n      material.needsUpdate = true;\n    });\n  });\n}\n/**\n * Specifies an envMap on an entity, without replacing any existing material\n * properties.\n */\n\n\nmodule.exports = AFRAME.registerComponent('cube-env-map', {\n  multiple: true,\n  schema: {\n    path: {\n      default: ''\n    },\n    extension: {\n      default: 'jpg',\n      oneOf: ['jpg', 'png']\n    },\n    format: {\n      default: 'RGBFormat',\n      oneOf: ['RGBFormat', 'RGBAFormat']\n    },\n    enableBackground: {\n      default: false\n    },\n    reflectivity: {\n      default: 1,\n      min: 0,\n      max: 1\n    },\n    materials: {\n      default: []\n    }\n  },\n  init: function () {\n    const data = this.data;\n    this.texture = new THREE.CubeTextureLoader().load([data.path + 'posx.' + data.extension, data.path + 'negx.' + data.extension, data.path + 'posy.' + data.extension, data.path + 'negy.' + data.extension, data.path + 'posz.' + data.extension, data.path + 'negz.' + data.extension]);\n    this.texture.format = THREE[data.format];\n\n    this.object3dsetHandler = () => {\n      const mesh = this.el.getObject3D('mesh');\n      const data = this.data;\n      applyEnvMap(mesh, data.materials, this.texture, data.reflectivity);\n    };\n\n    this.el.addEventListener('object3dset', this.object3dsetHandler);\n  },\n  update: function (oldData) {\n    const data = this.data;\n    const mesh = this.el.getObject3D('mesh');\n    let addedMaterialNames = [];\n    let removedMaterialNames = [];\n\n    if (data.materials.length) {\n      if (oldData.materials) {\n        addedMaterialNames = data.materials.filter(name => !oldData.materials.includes(name));\n        removedMaterialNames = oldData.materials.filter(name => !data.materials.includes(name));\n      } else {\n        addedMaterialNames = data.materials;\n      }\n    }\n\n    if (addedMaterialNames.length) {\n      applyEnvMap(mesh, addedMaterialNames, this.texture, data.reflectivity);\n    }\n\n    if (removedMaterialNames.length) {\n      applyEnvMap(mesh, removedMaterialNames, null, 1);\n    }\n\n    if (oldData.materials && data.reflectivity !== oldData.reflectivity) {\n      const maintainedMaterialNames = data.materials.filter(name => oldData.materials.includes(name));\n\n      if (maintainedMaterialNames.length) {\n        applyEnvMap(mesh, maintainedMaterialNames, this.texture, data.reflectivity);\n      }\n    }\n\n    if (this.data.enableBackground && !oldData.enableBackground) {\n      this.setBackground(this.texture);\n    } else if (!this.data.enableBackground && oldData.enableBackground) {\n      this.setBackground(null);\n    }\n  },\n  remove: function () {\n    this.el.removeEventListener('object3dset', this.object3dsetHandler);\n    const mesh = this.el.getObject3D('mesh');\n    const data = this.data;\n    applyEnvMap(mesh, data.materials, null, 1);\n    if (data.enableBackground) this.setBackground(null);\n  },\n  setBackground: function (texture) {\n    this.el.sceneEl.object3D.background = texture;\n  }\n});","map":null,"metadata":{},"sourceType":"script"}